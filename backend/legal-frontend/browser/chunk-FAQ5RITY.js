import{e as u}from"./chunk-E3OGELKA.js";import{P as m,S as c,W as l,a as d,b as g,ka as a,xc as p}from"./chunk-OAVOYKTW.js";var h=class o{darkMode=a(!0);accentColor=a("#6610f2");constructor(){localStorage.getItem("theme")==="light"?this.setDarkMode(!1):this.setDarkMode(!0);let t=localStorage.getItem("accent");t?this.setAccentColor(t):this.updateCssVariables("#6610f2")}toggleTheme(){this.animateThemeSwitch(),this.setDarkMode(!this.darkMode())}animateThemeSwitch(){document.body.classList.add("theme-transitioning"),setTimeout(()=>{document.body.classList.remove("theme-transitioning")},300)}setDarkMode(e){this.darkMode.set(e),e?(document.body.classList.add("dark-theme"),localStorage.setItem("theme","dark")):(document.body.classList.remove("dark-theme"),localStorage.setItem("theme","light"))}setAccentColor(e){this.accentColor.set(e),localStorage.setItem("accent",e),this.updateCssVariables(e)}updateCssVariables(e){document.documentElement.style.setProperty("--accent-color",e);let t=this.hexToRgb(e);t&&document.documentElement.style.setProperty("--accent-color-rgb",t)}hexToRgb(e){if(e=e.replace(/^#/,""),e.length===3&&(e=e.split("").map(i=>i+i).join("")),e.length!==6)return null;let t=parseInt(e.substring(0,2),16),r=parseInt(e.substring(2,4),16),n=parseInt(e.substring(4,6),16);return`${t}, ${r}, ${n}`}static \u0275fac=function(t){return new(t||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};var s=class extends Error{};s.prototype.name="InvalidTokenError";function y(o){return decodeURIComponent(atob(o).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function I(o){let e=o.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return y(e)}catch{return atob(e)}}function f(o,e){if(typeof o!="string")throw new s("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,r=o.split(".")[t];if(typeof r!="string")throw new s(`Invalid token specified: missing part #${t+1}`);let n;try{n=I(r)}catch(i){throw new s(`Invalid token specified: invalid base64 for part #${t+1} (${i.message})`)}try{return JSON.parse(n)}catch(i){throw new s(`Invalid token specified: invalid json for part #${t+1} (${i.message})`)}}var b=class o{constructor(e,t,r){this.http=e;this.themeService=t;this.router=r;this.loadUserFromToken()}apiUrl="/api/auth";tokenKey="auth_token";refreshKey="refresh_token";currentUser=a(null);login(e,t){return this.http.post(`${this.apiUrl}/login`,g(d({},e),{rememberMe:t})).pipe(m(r=>this.saveTokens(r.accessToken,r.refreshToken)))}saveTokens(e,t){localStorage.setItem(this.tokenKey,e),localStorage.setItem(this.refreshKey,t),this.decodeAndSetUser(e)}logout(){let e=localStorage.getItem(this.refreshKey);e?this.http.post(`${this.apiUrl}/logout`,{refreshToken:e}).subscribe({next:()=>this.performLocalLogout(),error:()=>this.performLocalLogout()}):this.performLocalLogout()}performLocalLogout(){localStorage.removeItem(this.tokenKey),localStorage.removeItem(this.refreshKey),localStorage.removeItem("theme"),localStorage.removeItem("accent"),this.currentUser.set(null),this.router.navigate(["/login"])}changePassword(e){return this.http.post(`${this.apiUrl}/change-password`,e)}getSessions(){return this.http.get(`${this.apiUrl}/sessions`)}revokeSession(e){return this.http.delete(`${this.apiUrl}/sessions/${e}`)}getToken(){return localStorage.getItem(this.tokenKey)}refreshToken(){let e=localStorage.getItem(this.refreshKey);return this.http.post(`${this.apiUrl}/refresh`,{refreshToken:e}).pipe(m(t=>{this.saveTokens(t.accessToken,t.refreshToken)}))}isLoggedIn(){return!!this.getToken()}decodeAndSetUser(e){try{let t=f(e);this.currentUser.set(t.user);let r=localStorage.getItem("accent"),n=localStorage.getItem("theme");r?this.themeService.setAccentColor(r):t.user.accent&&this.themeService.setAccentColor(t.user.accent),!n&&t.user.is_dark_mode!==void 0&&this.themeService.setDarkMode(t.user.is_dark_mode)}catch{this.logout()}}loadUserFromToken(){let e=this.getToken();e&&this.decodeAndSetUser(e)}static \u0275fac=function(t){return new(t||o)(l(p),l(h),l(u))};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};export{h as a,b};
