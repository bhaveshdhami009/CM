<div class="party-container">
  <div class="card">
    
    <!-- Header -->
    <div class="card__header">
      <div class="title-group">
        <h2>Client / Party Manager</h2>
        <p class="subtitle">Directory of all petitioners and respondents.</p>
      </div>
      
      <div class="header-controls">
        <!-- Search Box -->
        <div class="search-box">
          <i class="material-icons search-box__icon">search</i>
          <input 
            class="search-box__input" 
            [formControl]="searchControl" 
            placeholder="Search name, mobile...">
        </div>

        <button class="btn btn--primary" (click)="openCreateModal()">
          <i class="material-icons">person_add</i> Add Party
        </button>
      </div>
    </div>

    <!-- Body -->
    <div class="card__body" style="padding: 0;">
      
      <!-- Table -->
      <div class="table-responsive" *ngIf="!isLoading && parties.length > 0">
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Parentage</th>
              <th>Contact</th>
              <th>Address</th>
              <th style="text-align: right;">Actions</th>
            </tr>
            <!-- FILTER ROW -->
            <tr class="filter-row">
              <th>
                <input type="text" [(ngModel)]="filterValues.name" (keyup)="onFilterChange()" placeholder="Filter Name...">
              </th>
              <th>
                <input type="text" [(ngModel)]="filterValues.parentage" (keyup)="onFilterChange()" placeholder="Father/Mother...">
              </th>
              <th>
                <input type="text" [(ngModel)]="filterValues.mobile" (keyup)="onFilterChange()" placeholder="Filter Mobile...">
              </th>
              <th>
                <input type="text" [(ngModel)]="filterValues.city" (keyup)="onFilterChange()" placeholder="Filter City...">
              </th>
              <th></th> <!-- Actions -->
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of parties">
              <td>
                <span class="party-name">{{ p.first_name }} {{ p.middle_name }} {{ p.last_name }}</span>
              </td>
              <td>
                <div class="parentage-info">
                  <span class="parentage-info__father" *ngIf="p.father_name">F: {{ p.father_name }}</span>
                  <span class="parentage-info__mother" *ngIf="p.mother_name">M: {{ p.mother_name }}</span>
                </div>
              </td>
              <td>
                <div class="contact-info">
                  <span class="contact-info__mobile" *ngIf="p.mobile">
                    <i class="material-icons">phone</i> {{ p.mobile }}
                  </span>
                  <span class="contact-info__email" *ngIf="p.email">
                    {{ p.email }}
                  </span>
                </div>
              </td>
              <td>
                <span *ngIf="p.city">{{ p.city }}<span *ngIf="p.state">, {{ p.state }}</span></span>
                <span *ngIf="!p.city" class="text-secondary">-</span>
              </td>
              <td style="text-align: right;">
                <button class="btn btn--icon-only" (click)="openEditModal(p)">
                  <i class="material-icons">edit</i>
                </button>
                <button class="btn btn--icon-only text-danger" (click)="deleteParty(p.id)">
                  <i class="material-icons">delete</i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- STATES -->
      <div *ngIf="isLoading" class="state-message">
        <div class="spinner"></div>
        <p class="state-message__text">Loading directory...</p>
      </div>
      <div *ngIf="!isLoading && parties.length === 0" class="state-message">
        <i class="material-icons state-message__icon">group_off</i>
        <p class="state-message__text">No parties found.</p>
      </div>
    
    </div>
  </div>
</div>

<!-- === MODAL (Standardized) === -->
<div class="modal-overlay" *ngIf="showModal" (click)="showModal = false">
  
  <div class="modal-card modal-card--lg" (click)="$event.stopPropagation()">
    
    <!-- 1. Header (Outside Form) -->
    <div class="modal-card__header">
      <h3>{{ isEditMode ? 'Edit' : 'Add New' }} Party</h3>
      <button class="btn btn--icon-only" (click)="showModal = false">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <!-- 2. Form (Wraps Body & Footer) -->
    <form [formGroup]="partyForm" (ngSubmit)="save()">
      
      <!-- 3. Body (Scrollable Area) -->
      <div class="modal-card__body">
        
        <!-- Identity -->
        <div class="form-row">
          <div class="form-group">
            <label>First Name <span class="text-danger">*</span></label>
            <input formControlName="first_name" placeholder="First Name">
            <small class="error-text" *ngIf="partyForm.get('first_name')?.invalid && partyForm.get('first_name')?.touched">
              First name is required
            </small>
          </div>
          <div class="form-group">
            <label>Middle Name</label>
            <input formControlName="middle_name">
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input formControlName="last_name">
          </div>
        </div>

        <!-- Parentage -->
        <div class="form-row">
          <div class="form-group">
            <label>Father's Name</label>
            <input formControlName="father_name">
          </div>
          <div class="form-group">
            <label>Mother's Name</label>
            <input formControlName="mother_name">
          </div>
        </div>

        <!-- Guardian -->
        <div class="form-row">
          <div class="form-group">
            <label>Guardian Name</label>
            <input formControlName="guardian">
          </div>
          <div class="form-group">
            <label>Relation</label>
            <input formControlName="guardian_relation" placeholder="e.g. Wife of">
          </div>
        </div>

        <!-- Contact -->
        <div class="form-row">
          <div class="form-group">
            <label>Mobile 1</label>
            <input formControlName="mobile" maxlength="10">
            <small class="error-text" *ngIf="partyForm.get('mobile')?.hasError('pattern')">
              Must be 10 digits
            </small>
          </div>
          <div class="form-group">
            <label>Mobile 2</label>
            <input formControlName="mobile2" maxlength="10">
            <small class="error-text" *ngIf="partyForm.get('mobile2')?.hasError('pattern')">
              Must be 10 digits
            </small>
          </div>
          <div class="form-group">
            <label>Email Address</label>
            <input formControlName="email">
            <small class="error-text" *ngIf="partyForm.get('email')?.hasError('email')">
              Invalid email format
            </small>
          </div>
        </div>
        
        <!-- Address -->
        <div class="form-group" style="margin-bottom: 20px;">
          <label>Address</label>
          <input formControlName="address_line_1" placeholder="Line 1">
          <input formControlName="address_line_2" placeholder="Line 2" style="margin-top: 10px;">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>City</label>
            <input formControlName="city">
          </div>
          <div class="form-group">
            <label>State</label>
            <input formControlName="state">
          </div>
          <div class="form-group">
            <label>Pincode</label>
            <input formControlName="pincode" maxlength="6">
            <small class="error-text" *ngIf="partyForm.get('pincode')?.hasError('pattern')">
              Must be 6 digits
            </small>
          </div>
        </div>

        <!-- Remarks -->
        <div class="form-group">
          <label>Remarks</label>
          <textarea formControlName="remarks" rows="2"></textarea>
        </div>

      </div> <!-- End Body -->

      <!-- 4. Footer (Fixed at Bottom) -->
      <div class="modal-card__footer">
        <button type="button" class="btn btn--text" (click)="showModal = false">Cancel</button>
        <button type="submit" class="btn btn--primary" [disabled]="partyForm.invalid">Save Details</button>
      </div>

    </form>

  </div>
</div>